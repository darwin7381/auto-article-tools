# TinyPNG 圖片壓縮功能設置指南

## 功能概述

為了改善 WordPress 圖片上傳的成功率，系統現在支援自動圖片壓縮功能。當首圖大小超過 250KB 時，系統會自動使用 TinyPNG API 進行**多次壓縮**（最多3次），確保圖片大小達到理想範圍，然後再上傳到 WordPress。

## 設置步驟

### 1. 獲取 TinyPNG API Key

1. 前往 [TinyPNG Developer API](https://tinypng.com/developers)
2. 使用電子郵件註冊免費帳戶
3. 免費帳戶每月可壓縮 500 張圖片
4. 複製您的 API Key

### 2. 配置環境變數

在您的 `.env.local` 文件中添加：

```env
# TinyPNG 圖片壓縮 API Key
TINYPNG_API_KEY=your_api_key_here
```

## 工作流程

### 自動壓縮流程

1. **圖片大小檢查**：系統會檢查下載的圖片大小
2. **壓縮決策**：如果圖片超過 250KB，觸發多次壓縮流程
3. **多次 TinyPNG 壓縮**：
   - 第1次：使用 TinyPNG API 進行智能壓縮
   - 第2次：如果還未達到目標大小，繼續壓縮
   - 第3次：最後一次壓縮嘗試（最多3次）
   - 智能停止：如果壓縮效果小於5%，自動停止
4. **WordPress 上傳**：使用最終壓縮後的圖片上傳到 WordPress
5. **錯誤處理**：如果壓縮失敗，使用上一次結果或原始圖片繼續上傳

### 日誌輸出範例

```
原始圖片大小: 512.50 KB
圖片大小超過 250KB，開始使用 TinyPNG 壓縮...
開始使用 TinyPNG 多次壓縮圖片，原始大小: 512.50 KB，目標大小: 200 KB
第 1 次壓縮，當前大小: 512.50 KB
壓縮比例: 0.65，新大小: 332.13 KB
第 1 次壓縮完成，大小: 332.13 KB，減少: 35.2%
第 2 次壓縮，當前大小: 332.13 KB
壓縮比例: 0.72，新大小: 198.75 KB
第 2 次壓縮完成，大小: 198.75 KB，減少: 40.2%
已達到目標大小，停止壓縮
圖片壓縮完成！經過 2 次壓縮
最終結果: 512.50 KB -> 198.75 KB
總壓縮率: 61.2%
✅ 成功達到目標大小！
圖片多次壓縮完成，最終大小: 198.75 KB
```

## 測試工具

### 使用測試腳本

```bash
# 測試圖片壓縮功能
npx ts-node src/test-tinypng-compression.ts "https://example.com/large-image.jpg"
```

### 測試輸出範例

```
TinyPNG 圖片壓縮測試
圖片URL: https://example.com/large-image.jpg
API Key: abc12345...

1. 正在下載圖片...
原始圖片大小: 512.50 KB
圖片類型: image/jpeg

2. 檢查是否需要壓縮...
✅ 圖片大小超過 250KB，需要壓縮

3. 開始多次壓縮圖片...
目標大小: 250KB，最多壓縮3次
開始使用 TinyPNG 多次壓縮圖片，原始大小: 512.50 KB，目標大小: 250 KB
第 1 次壓縮，當前大小: 512.50 KB
第 1 次壓縮完成，大小: 332.13 KB，減少: 35.2%
第 2 次壓縮，當前大小: 332.13 KB
第 2 次壓縮完成，大小: 215.78 KB，減少: 35.0%
已達到目標大小，停止壓縮
圖片壓縮完成！經過 2 次壓縮
✅ 壓縮完成!
原始大小: 512.50 KB
壓縮後大小: 215.78 KB
壓縮比例: 57.9%
節省空間: 296.72 KB
🎯 成功達到目標大小！
```

## 錯誤處理

### 常見錯誤和解決方案

#### 1. API Key 未設置
```
錯誤: 未設置 TINYPNG_API_KEY 環境變數，跳過圖片壓縮
解決: 在 .env.local 中設置正確的 API Key
```

#### 2. API Key 無效
```
錯誤: TinyPNG 上傳失敗: 401 Unauthorized
解決: 檢查 API Key 是否正確
```

#### 3. API 配額用完
```
錯誤: TinyPNG 上傳失敗: 429 Too Many Requests
解決: 等待下個月或升級 TinyPNG 帳戶
```

#### 4. 壓縮失敗
```
警告: 圖片壓縮失敗，使用原始圖片繼續上傳
行為: 系統會繼續使用原始圖片上傳，不影響文章發布
```

## 效益

### 上傳成功率提升
- **原問題**：大圖片上傳到 WordPress 容易超時失敗
- **解決方案**：多次壓縮策略，確保圖片達到理想大小（200KB以下）
- **效果**：顯著提高上傳成功率，減少用戶重試次數

### 性能改善
- **載入速度**：壓縮後的圖片載入更快
- **頻寬節省**：減少數據傳輸量
- **儲存空間**：WordPress 媒體庫佔用更少空間

### 用戶體驗
- **無感知**：自動處理，用戶無需手動操作
- **容錯性**：壓縮失敗時自動回退到原始圖片
- **透明性**：詳細的日誌輸出便於問題診斷

## 技術實現細節

### 核心組件

1. **壓縮服務**：`src/services/compression/tinyPngService.ts`
2. **WordPress 上傳**：`src/services/wordpress/serverWordpressService.ts`
3. **測試工具**：`src/test-tinypng-compression.ts`

### 整合點

- WordPress 圖片上傳流程中自動觸發
- 適用於所有通過 URL 上傳的首圖
- 與現有的錯誤處理和日誌系統無縫整合

### 配置選項

- **壓縮閾值**：默認 250KB（觸發壓縮的門檻）
- **目標大小**：默認 200KB（多次壓縮的目標）
- **最大壓縮次數**：最多 3 次
- **智能停止**：壓縮效果小於 5% 時自動停止
- **API 超時**：TinyPNG API 調用超時設置
- **錯誤重試**：壓縮失敗時的處理策略

## 維護和監控

### 監控指標

1. **壓縮成功率**：通過日誌監控壓縮操作成功比例
2. **API 配額使用**：監控每月 API 調用次數
3. **效能提升**：比較壓縮前後的圖片大小

### 成本考量

- **免費額度**：每月 500 次壓縮（通常足夠）
- **付費方案**：如需更多配額可升級 TinyPNG 帳戶
- **ROI**：提升的用戶體驗和減少的技術支援成本 